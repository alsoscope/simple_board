<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="board">	
	<!-- 01_01 게시글 전체목록 조회 및 검색 조회까지 -->
	<select id="listAll" resultType="com.p.project.model.BoardVO">
		<!-- select * from tbl_board -->
		SELECT bno, title, content, writer, regdate, viewcnt FROM tbl_board
		<!-- WHERE 절을 include 태그로 삽입 -->
		<!-- <include refid="search"></include> -->
		ORDER BY bno desc, regdate desc
	</select>
	
	<!-- 페이징 처리 -->
	<!-- <select id="listPage" resultType="BoardVO">
		<![CDATA[
		SELECT bno, title, content, writer, regdate, viewcnt FROM tbl_board
		WHERE bno > 0 order by bno desc, regdate desc
		limit #{page}, 10
		]]>
	</select> -->
	
	<!-- 파라미터 없이 criteria 객체로 페이징 처리 -->
	<select id="listCriteria" resultType="com.p.project.model.BoardVO">
		<![CDATA[
		select bno, title, content, writer, regdate, viewcnt from tbl_board
		where bno > 0 order by bno desc, regdate desc
		limit #{pageStart}, #{perPageNum}
		]]>
	</select>
	
	<!-- totalCount 실제 게시물로 페이징 처리 -->
	<select id="countPaging" resultType="int">
		<![CDATA[
		select count(bno) from tbl_board where bno > 0
		]]>
	</select>

	<!-- 01_02 게시글 레코드 개수 -->
	<select id="countArticle" resultType="int">
		SELECT COUNT(*) FROM tbl_board
		<!-- WHERE 절을 include 태그로 삽입 -->
		<include refid="search"></include>
	</select>
	
	<!-- sql code 조각 -->
	<!-- 반복되는 sql의 일부를 sql태그를 이용하여 따로 빼둘 수 있다 -->
	<sql id="search">
		<choose>
			<!-- 검색옵션이 전체 검색일 경우 -->
			<when test="searchOption=='all'">
				WHERE writer like '%'||#{keyword}||'%'
				OR content like '%'||#{keyword}||'%'
				OR title like '%||'#{keyword}||'%'
			</when>
			<!-- 전체 검색이 아닐 경우 -->
			<otherwise>
				WHERE ${searchOption} like '%'#{keyword}'%'
			</otherwise>
		</choose>
	</sql>
	
	<!-- 02 게시글 작성 -->
	<!-- nvl(A,B):A가 null이면 B, null이 아니면 A 오라클 nvl(칼럼명, 0) mysql ifnull(칼럼명, 0)
		게시글 조회수 증가처리 쿼리 - 조회수(초기값=0)=조회수+1 -->
	<insert id="insert" parameterType="com.p.project.model.BoardVO">
		INSERT INTO tbl_board(bno, title, content, writer) VALUES (
		(SELECT IFNULL(MAX(bno)+1, 1) FROM tbl_board a),
		#{title}, #{content}, #{writer}
		)
	</insert>
	
	<!-- 03 게시글 상세보기 조회 -->
	<select id="view" resultType="com.p.project.model.BoardVO">
		SELECT * FROM tbl_board WHERE bno=#{bno}
	</select>
	
	<!-- 04 게시글 조회수 증가처리 -->
	<update id="increaseViewcnt">
		UPDATE tbl_board SET viewcnt=viewcnt+1
		WHERE bno=#{bno}
	</update>
	
	<!-- 05 게시글 수정처리 -->
	<update id="updateArticle">
		UPDATE tbl_board SET title=#{title}, content=#{content}, writer=#{writer}
		WHERE bno=#{bno}
	</update>
	
	<!-- 06 게시글 삭제처리 -->
	<delete id="deleteArticle">
		DELETE FROM tbl_board
		WHERE bno=#{bno}
	</delete>
</mapper>